<!-- @format -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/p5.js"></script> -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/addons/p5.sound.min.js"></script> -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <!-- <script src="p5.dom.js"></script> -->
  <title>test</title>
  <link rel="stylesheet" href="style.css">
<style type="text/css">
body {
  background-color: black;
  color: white;
  position: fixed;
  height: 100%;
  width: 100%
}
#popupBox {
  /*color: black;
  background-color: #ddd;*/
  color: white;
  background-color: black;
  border: solid 1px rgba(255,255,255,0.4);
  padding: 6px 0 6px 10px;
  font-size: 12px;
  line-height: 18px;
  z-index: 10;
  border-radius: 6px;
  box-shadow: 0 0 8px rgba(255,255,255,0.5);
  display: none;
  position: absolute;
 width: 300px;
}
.title {
  font-size: 24px;
  font-family: Gilroy;
  text-align: center;
}
.left-side {
  background-color: transparent;
  position: absolute;
  top: 60px;
  left: 10px;
  z-index: 5;
}
.right-side {
  background-color: transparent;
  position: absolute;
  top: 60px;
  z-index: 5;
  height: 90%;
  transition: right 0.5s;
  transition-timing-function: ease-in-out;
}
.left-panel {
  width: 380px;
  padding: 10px 0 10px 20px;
  border: 0.8px #ccc solid;
  border-radius: 10px;
  background-color: black;
}
.right-panel {
  width: 270px;
  padding: 10px 0 10px 20px;
  border: 0.8px #ccc solid;
  border-radius: 10px;
  background-color: black;
  float: right;
  margin-left: 10px;
}
.panel-title {
  font-size: 22px;
  margin-bottom: 6px;
}
.panel-text {
  font-family: Microsoft YaHei UI;
  font-size: 14px;
  margin-bottom: 4px;
}
#tree-nav {
  height: 200px;
  width: 360px;
}
#color-legend {
  height: 90px;
  width: 360px;
  margin-bottom: 10px;
}
#radius-legend {
  height: 100px;
  width: 260px;
  margin: 20px 0 20px;
}
#radius-legend img {
  width: 100%;
}
#flicker-legend {
  height: 50px;
  width: 360px;
}
@keyframes scaleDraw {  /*定义关键帧、scaleDrew是需要绑定到选择器的关键帧名称*/
  0%{
      transform: scale(1);  /*开始为原始大小*/
  }
  25%{
      transform: scale(0.4);
  }
  50%{
      transform: scale(1);
  }
  75%{
      transform: scale(0.4);
  }
}
.flicker{
  shape-rendering: crispEdges;
  margin: 15px 20px 0 20px;
  float: left;
  width: 20px;
  height: 20px;
  background-color: rgba(255,255,255,0.6);
  border: solid 0px rgba(255,255,255,0.6);
  border-radius: 50%;
  /*background-size: 150px 150px;*/
  -webkit-animation-name: scaleDraw; /*关键帧名称*/
  -webkit-animation-timing-function: ease-in-out; /*动画的速度曲线*/
  -webkit-animation-iteration-count: infinite;  /*动画播放的次数*/
  /*-webkit-animation-duration: 2s; 动画所花费的时间*/
}
.ring {
  float: left;
  border: solid 1px #fff;
  border-radius: 50%;
  shape-rendering: crispEdges;
}
.image-legend {
  width: 250px;
  padding: 10px 0 50px 0;
}
img{  
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
}
#pos-legend {
  width: 140px;
  float: right;
}
.element:hover {
  cursor: pointer;
}

#empty-container {
  display: flex;
  /* justify-content: center; */
  flex-direction: column;
  height: 80%;
  align-items: center;
  justify-content: center;
}
#empty-container img {
  opacity: .5;
  width: 150px;
}
#empty-container p {
  margin: 20px 0; 
  color: #999
}
/*css部分*/

</style>
</head>

<body>
<div id="popupBox">
  <span class="close-icon" onclick="this.parentNode.style.display = 'none'"></span>
  <div id="popupText"></div>
</div>
<!-- 标题区域 -->
<div class="title">The Universe of Mental Health in Tech Company</div>
<!-- <span class="triangle"></span>
<span class="interaction-into"> Middle-click to drag starry sky & Right-click to select an individual </span> -->
<!-- 左边栏区域 -->
<div class="left-side">
  <div class="left-panel">
    <div class="panel-title">Navigation</div>
    <div class="panel-text">Employees who have changed jobs</div>
    <div id="tree-nav"></div>
  </div>
  <hr style="background: black; border: none;" />
  <div class="left-panel">
    <div class="panel-title">Legend</div>
    <div class="panel-text">Colors - Mental Health Conditions</div>
    <div id="color-legend"></div>
    <div class="panel-text">Radius - Amount of Conditions</div>
    <div id="radius-legend">
      <img src="img/scale-legend.png" alt="">
    </div>
    <div class="panel-text">Flicker & Starrings - Discrimination</div>
    <div id="flicker-legend">
      <div class="flicker" style="-webkit-animation-duration: 1s;"></div>
      <div class="flicker" style="-webkit-animation-duration: 5s;"></div>
      <div class="flicker" style="-webkit-animation-duration: 10s;"></div>
      <div class="ring" style="width: 15px; height: 15px; margin: 17.5px 20px 0 20px;">
        <div style="width: 3px; height: 3px; margin: 6px 0 0 6.5px; background-color: rgba(255,255,255,0.6); border: solid 0px rgba(255,255,255,0.6); border-radius: 50%;"></div>
      </div>
      <div class="ring" style="width: 30px; height: 30px; margin: 10px 20px 0 20px;">
        <div style="width: 3px; height: 3px; margin: 13.5px 0 0 13.5px; background-color: rgba(255,255,255,0.6); border: solid 0px rgba(255,255,255,0.6); border-radius: 50%;"></div>
      </div>
    </div>
  </div>
</div>
<!-- 右边栏区域 -->
<div class="right-side" style=" right: -704px;">
    <!-- 按钮区域 -->
    <div style="width: 60px; height: 200px; bottom: 20px; left: -60px; position: absolute;">
      <div class="interact-button" id="showBtn" style="margin-bottom: 20px" value="false" onclick="showDetail(this)">
        <p class="detail-icon"></p>
        <p>Detail</p>
      </div>
      <div class="interact-button" id="drag" style="margin-bottom: 20px" onclick="changeButton(this)">
        <p class="drag-icon"></p>
        <p>Drag</p>
      </div>
      <div class="interact-button" id="lasso" onclick="changeButton(this)">
        <p class="lasso-icon"></p>
        <p>Select</p>
      </div>
    </div>
    <!-- 细节描述框 -->
    <div class="right-panel" style="width: 380px;">
      <div class="panel-title">Detail icon</div>
      <div class="panel-text" style="margin-bottom: 20px;">Please CLICK one of the elements for analyizing:</div>
      <div id="empty-container">
        <img src="img/empty-icon.png" alt="">
        <p>Please select the stars in starry sky.</p>
      </div>
      <div id="svgContainer"></div>
    </div>
    <!-- 细节标签 -->
    <div class="right-panel">
      <div class="panel-title">Legend</div>
      <div class="panel-text">Shape & Area - Individual</div>
      <div class="image-legend"><img src="img/资源 1.svg"></div>
      <div class="panel-text">Mental Health Benifits - Orbits</div>
      <div class="image-legend"><img src="img/资源 2.svg"></div>
      <div class="panel-text">Willing to Expose & Work Position</div>
      <div style="height: 150px;">
        <div id="pos-legend"></div>
          <div style="width: 120px; padding: 20px 0 0 0;"><image src="img/资源 4.svg" title="pei"/></div>
        </div>
    </div>
</div>
  <!-- <input></input> -->
  <script>
    var showDetailClickCount = 0;
    function showDetail() {
      var showDetail = document.getElementById("showBtn").getAttribute("value");
      // console.log("before", showDetail);
      if (showDetail == "false") {
        showDetailClickCount += 1
        document.getElementsByClassName('detail-icon')[0].style.opacity = .6
        if(showDetailClickCount === 1) {
          document.getElementsByClassName("right-side")[0].style.right = "-272px";
        } else if(showDetailClickCount === 2){
          document.getElementsByClassName("right-side")[0].style.right = "20px";
          showDetailClickCount = 0
          document.getElementById("showBtn").setAttribute("value", "true");
        }
        // console.log("a")
      }
      else if(showDetail == "true") {
        document.getElementsByClassName('detail-icon')[0].style.opacity = 1
        document.getElementsByClassName("right-side")[0].style.right = "-704px";
        document.getElementById("showBtn").setAttribute("value", "false");
        // console.log("b")
      }
      // console.log("after", document.getElementById("showBtn").getAttribute("value"));

      //getElementsByClassName("left-side")[0].
    }
    document.getElementById("popupBox").style.display = "none";

    // 职位
    var positions = ["Back-end Developer","Front-end Developer", "Supervisor/Team Lead", "DevOps/SysAdmin", "Support", "One-person shop", "Designer", "Dev Evangelist/Advocate", "Executive Leadership", "Sales", "HR", "Other"];

    var posSVG = d3.select("#pos-legend").append("svg").attr("height", 150).attr("width", 140);

    var position = posSVG.append("text")
      .attr("transform", "translate(70, 130)")
      .attr("dy", 7)
      .style("fill", "white")
      .style("font-size", 12)
      .style("text-anchor", "middle");

    posSVG.selectAll("circle")
      .data(positions).enter().append("circle")
      .attr("cx", function(d,i) { return 38*Math.cos(i*2*Math.PI/12 + 1.5*Math.PI) + 70; })
      .attr("cy", function(d,i) { return 38*Math.sin(i*2*Math.PI/12 + 1.5*Math.PI) + 64; })
      .attr("r", 4.5).style("fill", "white").style("opacity", 0.6).style("cursor", "pointer")
      .on("mouseover", function(d,i) {
        d3.select(this).attr("r", 6).style("opacity", 1)
        .attr("cx", function() { return 40*Math.cos(i*2*Math.PI/12 + 1.5*Math.PI) + 70; })
        .attr("cy", function() { return 40*Math.sin(i*2*Math.PI/12 + 1.5*Math.PI) + 64; });
        position.text(positions[i]);
      })
      .on("mouseout", function(d,i) {
        d3.select(this).attr("r", 4.5).style("opacity", 0.6)
        .attr("cx", function() { return 38*Math.cos(i*2*Math.PI/12 + 1.5*Math.PI) + 70; })
        .attr("cy", function() { return 38*Math.sin(i*2*Math.PI/12 + 1.5*Math.PI) + 64; });
      });

    // 花瓣
    var starSVG = d3.select("#color-legend").append("svg").attr("height", 90).attr("width", 360);

    var conditions = ["Mood Disorder", "Anxiety Disorder", "Attention Deficit Hyperactivity Disorder", "Post-traumatic Stress Disorder", "Obsessive-Compulsive Disorder", "Substance Use Disorder", "Personality Disorder", "Stress Response Syndromes", "Addictive Disorder", "Eating Disorder", "Dissociative Disorder", "Psychotic Disorder"];//"Other"

    var colors = ["#eb3a4b", "#eb4f27", "#f19637", "#fcea4f", "#9bfb4e", "#69e282", "#6ee5b9","#68e2fc", "#407bf7", "#425ef5", "#5d30f5", "#c333f1"]; //

    var condition = starSVG.append("text")
      .attr("transform", "translate(90, 45)")
      .attr("dy", 7)
      .style("fill", "white")
      .style("font-size", 12);

    starSVG.selectAll("circle")
      .data(colors).enter().append("circle")
      .attr("cx", function(d, i) { return 24*Math.cos(i*2*Math.PI/12 + 1.5*Math.PI) + 46; })
      .attr("cy", function(d, i) { return 24*Math.sin(i*2*Math.PI/12 + 1.5*Math.PI) + 45; })
      .attr("r", 10).style("fill", function(d) { return d; })
      .style("cursor", "pointer").style("opacity", 0.8)
      .on("mouseover", function(d, i) {
          d3.select(this)
          .attr("r", 12)
          .attr("cx", function() {
              return 27*Math.cos(i*2*Math.PI/12 - 0.5*Math.PI) + 46;
          })
          .attr("cy", function() {
              return 27*Math.sin(i*2*Math.PI/12 - 0.5*Math.PI) + 45;
          });
          condition.text(conditions[i]);
      })
      .on("mouseout", function(d,i) {
          d3.select(this)
          .attr("r", 10)
          .attr("cx", function() {
              return 24*Math.cos(i*2*Math.PI/12 + 1.5*Math.PI) + 46;
          })
          .attr("cy", function() {
              return 24*Math.sin(i*2*Math.PI/12 + 1.5*Math.PI) + 45;
          });
          condition.text('');
      });


    let data = {}; //全局对象
    let bubbles = []; //全局数组
    var datas = [];
    let SizeSlider;
    var idList = [] //每次圈选的item的id
    var newDataSet = [] //每次圈选的全局数据
    var dataSet = []; //全局数据
    var item_interval = 10; //每个气泡的间距
    var posData = [];//存放点的最终位置的数组
    var posDataTotal = [];
    var initPosData = [];
    var size = 1;//缩放比率
    R = 0.8;//星球的布局半径  
    var B;
    var drag = false;
    var wheelScale; //缩放常数（1.25 ，-1.25）
    var currentSliderBarValue; //
    var selectedNodeName; //树：筛选名
    var buttonState ='lasso'; 
    var xPosScale, yPosScale;
    var tempWindowWidth, tempWindowHeight
    var useCanvasValid = false;

    function copyArr(arr) {
        let res = [];
        for(let i in arr) {
          res.push(arr[i]);
        }
        return res;
      }

    //载入JSON
    function preload() {
      data = loadJSON("2016.json");
    }

    function setup() {
      var xScale = windowWidth/(80*2);
      var yScale = windowHeight/(40*2);
      xPosScale = xScale;
      yPosScale = yScale;
      // SizeSlider = createSlider(0, 25, 1.5);
      // SizeSlider.class('size-sliderbar')
      // process data
      for (let i in data) {
      //if (i < 500) {
          posData.push({
              // 画面中心坐标 +- 比例尺
              'id': i,
              'self-employed': data[i]['Are you self-employed?'],
              'IT-company': data[i]['Is your employer primarily a tech company/organization?'],
              'pre-employers': data[i]['Do you have previous employers?'],
              'Tech-role': data[i]['Is your primary role within your company related to tech/IT?'],
              'x': windowWidth/2 + xScale*data[i].x,
              'y': windowHeight/2 + yScale*data[i].y,
              'ox': 0,
              'oy': 0,
              'condition': split(data[i]['If so, what condition(s) were you diagnosed with?'], '|'),
              'view': data[i]['Do you think that team members/co-workers would view you more negatively if they knew you suffered from a mental health issue?']
          })
      //}
      } 
      posDataTotal = posData;
      initPosData = copyArr(posData)
      // createCanvas(windowWidth, windowHeight);
      // noStroke();
    }

    /* 角度自适应封装方法 */
    function angleSelfAdaption(arr, r, delta) {
      let angleArr = []
      if(arr.length > 0) {
        for(let i = 0; i < arr.length; i++) {
          let d = {}
          // // 没病的人或一种病 无偏移
          // if (arr.length == 1) {
          //     d.x = 0; d.y = 0; 
          // }
          // // 多于一种病 有偏移
          // else {
              d.x = r * (sin(-i * TWO_PI / arr.length + delta));
              d.y = r * (cos(-i * TWO_PI / arr.length+ delta));
          // }
          angleArr.push(d)
        } 
      }
     return angleArr
    }

    /* 绘制图像 */
    function draw() {
      createCanvas(windowWidth, windowHeight);
      background(0);
      var t = millis() / 1000;
      // size = SizeSlider.value();
      push();
      fill('rgba(255,255,255,0.2)');
      //noFill();
      stroke('rgba(255,255,255,0.6)');
      strokeWeight(1.5);
      rect(recPosX, recPosY, recWidth, recHeight, 5);
      pop();
      tempWindowWidth = windowWidth;
      tempWindowHeight = windowHeight;

      posData.forEach((pos, i) => {
        // 计算明度
        var brightness = 70 + 6*pos.condition.length;
        // 计算小圆半径 星环半径
        var r = 0, ring = 0;
        if (pos.view == "Yes, they do") {
            r = size * (pos.condition.length*Math.abs(sin(10*t+0.1*i)));
        } else if (pos.view == "Yes, I think they would") {
            r = size * (pos.condition.length*Math.abs(sin(4*t+0.1*i)));
        } else if (pos.view == "Maybe") {
            r = size * (pos.condition.length*Math.abs(sin(2*t+0.1*i)));
        } else if (pos.view == "No, I don't think they would") {
            r = size * (pos.condition.length );
            ring = 8 * size;
        } else if (pos.view == "No, they do not") {
            r = size * (pos.condition.length);
            ring = 25 * size;
        }

        // 星环
        push();
        stroke(255, brightness);
        strokeWeight(size/4);
        noFill();
        if (ring > 0)  ellipse(pos.x, pos.y, ring, ring);
        pop();

        // 病情
        var dx, dy; // 小圆偏移
        pos.condition.forEach((condition, j) => {
            // 没病的人或一种病 无偏移
            if (pos.condition.length == 1) {
                dx = 0; dy = 0;
            }
            // 多于一种病 有偏移
            else {
                dx = (r/3) * sin(j * TWO_PI / pos.condition.length);
                dy = (r/3) * cos(j * TWO_PI / pos.condition.length);
            }                
            push();
            colorMode(HSB, 360, 100, 100, 100); //色相 饱和度 明度 透明度
            //fill(240, 1, brightness, brightness / 10); 
            blendMode(LIGHTEST); //加色混合

            if (condition == 'Mood Disorder (Depression, Bipolar Disorder, etc)') {
                fill(354.24, 354.24, brightness);
            } else if (condition == 'Anxiety Disorder (Generalized, Social, Phobia, etc)') {
                fill(285.47, 78.84, brightness);
            } else if (condition == 'Attention Deficit Hyperactivity Disorder') {
                fill(253.71, 80.41, brightness);
            } else if (condition == 'Post-traumatic Stress Disorder') {
                fill(230.61, 73.06, brightness);
            } else if (condition == 'Obsessive-Compulsive Disorder') {
                fill(220.66, 74.09, brightness);
            } else if (condition == 'Substance Use Disorder') {
                fill(190.54, 58.73, brightness);
            } else if (condition == 'Personality Disorder (Borderline, Antisocial, Paranoid, etc)') {
                fill(157.82, 51.97, brightness);
            } else if (condition == 'Stress Response Syndromes') {
                fill(132.4, 53.54, brightness);
            } else if (condition == 'Addictive Disorder') {
                fill(93.29, 68.92, brightness);
            } else if (condition == 'Eating Disorder (Anorexia, Bulimia, etc)') {
                fill(53.76, 68.65, brightness);
            } else if (condition == 'Dissociative Disorder') {
                fill(30.65, 77.18, brightness);
            } else if (condition == 'Psychotic Disorder (Schizophrenia, Schizoaffective, etc)') {
                fill(12.24, 83.4, brightness);
            } else if (condition == '') {
              push();
            rectMode(CENTER);
            translate(pos.x,pos.y);
            rotate(PI / 4);
            fill(255, 100);
            rect(0, 0, r,r);
            pop();
            } else {
                fill(100, 100, brightness);
            }
            ellipse(pos.x + dx, pos.y + dy, r, r);
            pop();
        })
      })
    }

    let recPosX, recPosY, recWidth, recHeight, endPosX, endPosY;
    
    function mousePressed(e) {
      //判断是否在svg区域上，是的话禁用鼠标
      // console.log(d3.event.target,'d3.event.target.localName')
      if(e.toElement.tagName === 'CANVAS') {
        // console.log(e.toElement.tagName,'e')
        switch (mouseButton) {
          case LEFT:
            if(buttonState == 'lasso') {
              idList = [];
              newDataSet = [];
              recWidth = 0;
              recHeight = 0;
              recPosX = mouseX;
              recPosY = mouseY;
              d3.select('#svgWrapper').remove()
            }
            else if(buttonState == 'drag') {
              posData.forEach((pos, i) => {
                pos.ox = mouseX - pos.x;
                pos.oy = mouseY - pos.y;
              })
              document.getElementsByTagName('canvas')[0].setAttribute('class','move-state')
            }
          break;
          case CENTER:
            // if(buttonState == 'drag') {
                // 记录鼠标相对元素的偏移量
                posData.forEach((pos, i) => {
                    pos.ox = mouseX - pos.x;
                    pos.oy = mouseY - pos.y;
                })
                document.getElementsByTagName('canvas')[0].setAttribute('class','move-state')
            // }
          break;
        }
        document.getElementById("popupBox").style.display = "none";
 
      }
    }

    function mouseDragged(e) {
      if(e.toElement.tagName === 'CANVAS') {
      switch (mouseButton) {
        case LEFT:
          if(buttonState == 'lasso') {
            recWidth = mouseX - recPosX;
            recHeight = mouseY - recPosY;
          } else if (buttonState == 'drag'){
            // 元素位置 = 鼠标位置 - 偏移量
            posData.forEach((pos, i) => {
                pos.x = mouseX - pos.ox;
                pos.y = mouseY - pos.oy;
            })
            document.getElementsByTagName('canvas')[0].setAttribute('class','move-state')
          }
        break;
        case CENTER:
          // if (buttonState == 'drag') {
            // 根据偏移量修改位置坐标
            posData.forEach((pos, i) => {
                pos.x = mouseX - pos.ox;
                pos.y = mouseY - pos.oy;
            })
            document.getElementsByTagName('canvas')[0].setAttribute('class','move-state')
          // }
        break;
      }
    }
    }

    function mouseReleased(e) {
      if(e.toElement.tagName === 'CANVAS') {
      switch(mouseButton) {
        case LEFT:
          if(buttonState == 'lasso') {
            useLasso()
          } else if (buttonState == 'drag'){
            document.getElementsByTagName('canvas')[0].removeAttribute('class','move-state')
          }
        break;
        case CENTER:
          // if(buttonState == 'drag') {
            document.getElementsByTagName('canvas')[0].removeAttribute('class','move-state')
          // }
        break;
      }
    }
    }

    function changeButton(btn) {
      if(btn.id == 'lasso') {
        buttonState = 'lasso'
        document.getElementsByClassName('lasso-icon')[0].style.opacity = .6
        document.getElementsByClassName('drag-icon')[0].style.opacity = 1
        document.getElementsByClassName('right-side')[0].style.right = "-292px"
        document.getElementById("showBtn").setAttribute("value", "true")
        console.log(document.getElementById("showBtn").getAttribute("value"))
      } else if(btn.id == 'drag') {
        buttonState = 'drag'
        document.getElementsByClassName('drag-icon')[0].style.opacity = .6
        document.getElementsByClassName('lasso-icon')[0].style.opacity = 1
      }
    }

    // 滚轮改变缩放没有过渡效果，但触控板连续变化
    function mouseWheel(event) {
        // delta = 125 滚动一格的默认高度值，wheelScale 缩放比率
        if (event.delta < 0) {
            wheelScale = 1.25; // 上滚放大
            R *= (1*wheelScale); // 错位感
        } else {
            wheelScale = 0.8; // 下滚缩小 取倒数
            R *= (wheelScale/1); // 错位感
        }
        // 大小按照比例缩放
        size *= wheelScale;
        // console.log('size', size);
        
        posData.forEach((pos, i) => {
            // 偏移量 = 缩放比率 * (元素位置 - 画面中心)
            pos.ox = wheelScale * (pos.x - windowWidth/2);
            pos.oy = wheelScale * (pos.y - windowHeight/2);

            // 画面中心 + 偏移量 = 元素位置
            pos.x = windowWidth/2 + pos.ox;
            pos.y = windowHeight/2 + pos.oy;
        })

        // 禁用浏览器默认滚动
        return false;
    }

    // 触控板有时会失控 应该禁用 还未解决
    function touchStarted() {
        return false;
    }
    function touchMoved() {
        return false;
    }
    function touchEnded() {
        return false;
    }

    /* 使用套索工具 */
    function useLasso() {
      showDetailClickCount = 1;
      document.getElementsByClassName('detail-icon')[0].style.opacity = .6
      document.getElementsByClassName("right-side")[0].style.right = "-272px";
      recWidth = 0;
      recHeight = 0;
      endPosX = mouseX;
      endPosY = mouseY;
      //值得注意的是不同的拖动方向（左上，右上，左下，右下），绘制的方法有区别，需要交换一下值 
      let tempSwitchX, tempSwitchY
      if(endPosX < recPosX) {
        tempSwitchX = recPosX
        recPosX = endPosX
        endPosX = tempSwitchX
      }
      if(endPosY < recPosY) {
        tempSwitchY = recPosY
        recPosY = endPosY
        endPosY = tempSwitchY
      }
      //遍历每个bubble，符合位置的即为选中
      for (let i = 0; i < posData.length; i++) {
        let CanXX = posData[i].x
        let CanYY = posData[i].y
        if(Number(CanXX) < Number(endPosX) && Number(CanXX) > Number(recPosX) && Number(CanYY) < Number(endPosY) && Number(CanYY) > Number(recPosY)) {
          if(idList.indexOf(posData[i].id) === -1) {
            idList.push(posData[i].id)
          }
        }
      }
      for(let i=0; i< idList.length; i++) {
           newDataSet.push(dataSet[idList[i]])
      }
      drawPlanet(newDataSet)
      if(idList.length > 0) {
        document.getElementById('empty-container').style.display = 'none'
        document.getElementById('svgContainer').style.display = 'block'
      } else {
        document.getElementById('empty-container').style.display = 'flex'
        document.getElementById('svgContainer').style.display = 'none'
      }
      document.getElementById('svgContainer').setAttribute('class', 'slidedown')
    }

    //初始化:选中套索工具(样式选中状态)
    if(buttonState === 'lasso') {
        document.getElementsByClassName('lasso-icon')[0].style.opacity = .6
      }

    /* 数组分段函数 */
    function sliceArray(array, size) {
      var result = []; //Math.ceil有多余的小数点都取最大整数
        for (var x = 0; x < Math.ceil(array.length / size); x++) {
          var start = x * size;
          var end = start + size;
          result.push(array.slice(start, end));
        }
        return result;
    }

    /* 弹出框 */
    function showPopup(infoElem) {
          let popupBox = document.getElementById('popupText')
          let age = infoElem['What is your age?']
          let gender = infoElem['What is your gender?']
          let comment = infoElem['Why or why not?(mental)']
          let conditions = infoElem['If so, what condition(s) were you diagnosed with?']
          let positions = infoElem['Which of the following best describes your work position?']
          popupBox.innerHTML = '(1) Age: ' + age + '<br/>' 
          + '(2) Genger: ' + gender + '<br/>'
          + '(3) Conditions: ' + conditions + '<br/>' 
          + '(4) Positions: ' + positions + '<br/>' 
          + '(5) Bring Mental Health in Interview?: ' + comment
          // console.log(infoElem)
          document.getElementById('popupBox').style.display = 'block'
      }

    d3.csv('2016-csv-pre.csv').then(function(rawData) {
      dataSet = rawData
      // drawPlanet(dataSet)
      // console.log(dataSet) //有数据
      // let treatment = dataSet.filter(d=>{return d['treatment'] === 'Yes' && d['comments'] !== 'NA'})
    })
    function drawPlanet(dataSet) {
        /* 开始分隔, 分割后的数据用来直接data()绑定,排序的转折点 */
        var sampleNum = 4
        var len = dataSet.length
        var rowLen = len/sampleNum
        /*求年龄最大值 最小值*/
        var ageList = dataSet.map(function(d) {
          let age = Number(d['What is your age?'])
          if(age > 0 && age < 100) {
            return age
          }
        })
        var rowDataSet = sliceArray(dataSet, sampleNum);
        var width = 350
        var height = 70*(rowLen+15)
        var svg = d3.select('#svgContainer').append('svg').attr('id','svgWrapper').attr('width', width).attr('height', height)
        /* 通过循环row数组达到每行绘制的效果 */
        rowDataSet.forEach((item, i) => {
        let row = svg.append('g').attr('rowKey', i).attr('transform', function() {
          return 'translate(50, '+ (i*110+90) +')'
        })
        let g = row.selectAll('.element').data(item).enter().append('g').attr('class','element')
        .attr('transform', function(d, i) {
          return 'translate(' + (i*90-10) +','+ 0 +'), rotate(0)'
          // return 'translate(' + posData[i]['x'] +','+ posData[i]['y'] +'), rotate(0)'
        })
        .on("mouseover", function(d, i) {
          // showPopup(d)
          // console.log('000')
        })

        let light_radius = 22
        let single_angle = Math.PI/13
        let pos_radius = light_radius - 9
        let opacity_value = .7
            // Detect the appropriate vendor prefix.
        var prefix = "-webkit-transform" in document.body.style ? "-webkit-"
        : "-moz-transform" in document.body.style ? "-moz-"
        : "";
        var conditionsList = ['Mood Disorder (Depression, Bipolar Disorder, etc)', 'Anxiety Disorder (Generalized, Social, Phobia, etc)', 'Attention Deficit Hyperactivity Disorder',
         'Post-traumatic Stress Disorder' ,'Obsessive-Compulsive Disorder', 'Substance Use Disorder', 
         'Personality Disorder (Borderline, Antisocial, Paranoid, etc)', 'Stress Response Syndromes', 'Addictive Disorder',
         'Eating Disorder (Anorexia, Bulimia, etc)', 'Dissociative Disorder', 'Psychotic Disorder (Schizophrenia, Schizoaffective, etc)',
         'Other']

         let condition_colors = ['#eb3a4b', '#c333f1', '#5d30f5', 
         '#425ef5', '#407bf7', '#68e2fc',
         '#6ee5b9', '#69e282', '#9bfb4e',
         '#fcea4f', '#f19637', '#eb4f27','#ffffff']
         
         function filterSplit(str, gap) {
            let realArr = []
            let arr = split(str, gap)
            if(arr[0] !== "") {
              realArr = arr
            }
            return realArr
         }

         /*  再次绘制光晕*/
         g.selectAll('.halo').data(function(d) {
           //循环元素，每一次获取到元素的conditions,
           //每绘制一个光晕，判断它在当前花瓣应该在的位置
          let conditions = filterSplit(d['If so, what condition(s) were you diagnosed with?'], '|')
          let angleForXY = angleSelfAdaption(conditions, pos_radius, 0)
          let halos = []
          for(let i = 0; i < conditions.length; i++) {
            let currentColorForConditionsIndex = conditionsList.indexOf(conditions[i])
            currentColorForConditionsIndex= currentColorForConditionsIndex !== -1 ? currentColorForConditionsIndex : 12
            let conColor = condition_colors[currentColorForConditionsIndex]
            let haloObj = {
              'cx': angleForXY[i].x,
              'cy': angleForXY[i].y,
              'color': conColor
            }
            halos.push(haloObj)
          }
          //  console.log(d)
           //根据conditions返回绘制光晕数据的数组，动态的长度
           return halos
         }).enter().append('circle')
         .attr('class','halo')
         .attr('r', light_radius)
         .attr('cy', d=>d.cy)
         .attr('cx', d=>d.cx)
         .attr('fill',d=>d.color)
         .attr('fill-opacity', opacity_value)
         .style("filter", "url(#motionFilter)")

        var sizeScale = d3.scaleLinear().domain([d3.min(ageList), d3.max(ageList)]).range([0, 300]);
        var transformScale = d3.scaleLinear().domain([d3.min(ageList), d3.max(ageList)]).range([.5, 1.8]);
        var defs = svg.append("defs");

        //Initialize the filter
        defs.append("filter")
            .attr("id", "motionFilter") //Give it a unique ID
            //Increase the width of the filter region to remove blur "boundary"
            .attr("width", "300%")
            //Put center of the "width" back in the middle of the element
            .attr("x", "-100%")
            .append("feGaussianBlur") //Append a filter technique
            .attr("class", "blurValues") //Needed to select later on
            .attr("in", "SourceGraphic") //Apply blur on the applied element
            //Do a blur of 8 standard deviations in the horizontal
            //direction and 0 in vertical
            .attr("stdDeviation", "5 5");
      
        //公司环境1：benefits
        g.append("ellipse")
        .attr("rx", function(d) {
          let benefits = d['Does your employer provide mental health benefits as part of healthcare coverage?']
          if( benefits === 'Yes') {
            return 25
          }  else {
            return 0
          }
        })
        .attr("ry", 10)
        .attr('stroke', '#fff')
        .attr('fill', 'transparent')
        .attr('stroke-width', 1)
        .attr("transform", "rotate(90)")
        .attr('stroke-dasharray', 1)

        //公司环境2：options
        g.append("ellipse")
        .attr("rx", function(d) {
          let options = d['Do you know the options for mental health care available under your employer-provided coverage?']
          if( options === 'Yes') {
            return 25
          } else {
            return 0
          }
        })
        .attr("ry", 10)
        .attr('stroke','#fff')
        .attr('fill', 'transparent')
        .attr('stroke-width', 1)
        .attr("transform", "rotate(-45)")
        .attr('stroke-dasharray', 1)

         //公司环境3：discussion
         g.append("ellipse")
        .attr("rx", function(d) {
          let discussion = d['Has your employer ever formally discussed mental health (for example, as part of a wellness campaign or other official communication)?']
          if( discussion === 'Yes') {
            return 25
          } else {
            return 0
          }
        })
        .attr("ry", 10)
        .attr('stroke','#fff')
        .attr('stroke-width', 1)
        .attr('fill', 'transparent')
        .attr("transform", "rotate(0)")
        .attr('stroke-dasharray',1)

        //公司环境4：seek_help
        g.append("ellipse")
        .attr("rx", function(d) {
          let seek_help = d['Does your employer offer resources to learn more about mental health concerns and options for seeking help?']
          // console.log(seek_help,'seek_help')
          if( seek_help === 'Yes') {
            return 25
          } else {
            return 0
          }
        })
        .attr("ry", 10)
        .attr('stroke','#fff')
        .attr('fill', 'transparent')
        .attr('stroke-width', 1)
        .attr("transform", "rotate(45)")
        .attr('stroke-dasharray', 1)

        
        //公司环境5(老板)：medical_coverage
        g.append("ellipse")
        .attr("rx", function(d) {
          let medical_coverage = d['Do you have medical coverage (private insurance or state-provided) which includes treatment of mental health issues?']
          // console.log(medical_coverage,'medical_coverage')
          if(medical_coverage == 1) {
            return 25
          } else {
            return 0
          }
        })
        .attr("ry", 10)
        .attr('stroke','#fff')
        .attr('fill', 'transparent')
        .attr('stroke-width', 1)
        .attr("transform", "rotate(-45)")
        // .attr('stroke-dasharray', 1)

        //公司环境6(老板)：online_resources
        g.append("ellipse")
        .attr("rx", function(d) {
          let online_resources = d['Do you know local or online resources to seek help for a mental health disorder?']
          if(online_resources == 'I know some') {
            return 25
          } else {
            return 0
          }
        })
        .attr("ry", 10)
        .attr('stroke','#fff')
        .attr('fill', 'transparent')
        .attr('stroke-width', 1)
        .attr("transform", "rotate(45)")
        // .attr('stroke-dasharray', 1)

        /**** 倾诉程度 ****/
        //倾诉对象: coworkers
        g.append("circle")
          // .attr('r', 10)
          .attr('r',function(d) {
            let coworkers = d['Would you feel comfortable discussing a mental health disorder with your coworkers?']
            if( coworkers === 'Yes') {
              return 15
            } else {
              return 0
            }
          })
          .attr('fill', '#fff')
          .attr('fill-opacity', .2)
          .attr('stroke-width', .5)
          // .attr('stroke-dasharray', 1)

        //倾诉对象: supervisor
        g.append("circle")
          // .attr('r', 15)
          .attr("transform", 'rotate(45)')
          .attr("r", function(d) {
            let supervisor = d['Would you feel comfortable discussing a mental health disorder with your direct supervisor(s)?']
            if( supervisor === 'Yes') {
              return 20
            } else {
              return 0
            }
          })
          .attr('fill', '#fff')
          .attr('fill-opacity', .18)
          .attr('stroke-width', .5)
          // .attr('stroke-dasharray', 1)

        //倾诉对象: employer
        g.append("circle")
          .attr("transform", 'rotate(-45)')
          .attr("r", function(d) {
            let employer = d['Do you think that discussing a mental health disorder with your employer would have negative consequences?']
            if( employer === 'Yes') {
              return 25
            } else {
              return 0
            }
          })
          .attr('fill', '#fff')
          .attr('fill-opacity', .12)
          .attr('stroke-width', .5)
          // .attr('stroke-dasharray', 1)

        /****  映射职业啦:卫星  ****/
        let satellite_self_radius = 1
        let satellite_radius = 27
        let single_satellite_angle = Math.PI/12
        let pos_list = ['Back-end Developer', 'Front-end Developer', 'Supervisor/Team Lead', 
        'DevOps/SysAdmin', 'Support', 'One-person shop', 
        'Designer', 'Dev Evangelist/Advocate', 'Executive Leadership',
        'Sales', 'HR', 'Other']

        g.selectAll('.satellite').data(function(d) {
           //循环元素，每一次获取到元素的positions,
           //每绘制一个光晕，判断它在当前花瓣应该在的位置
          let positions = filterSplit(d['Which of the following best describes your work position?'], '|')
          let angleForXY = angleSelfAdaption(pos_list, satellite_radius, -Math.PI)
          let satellites = []
          for(let i = 0; i < positions.length; i++) {
            let currentColorForPositionsIndex = pos_list.indexOf(positions[i])
            currentColorForPositionsIndex= currentColorForPositionsIndex !== -1 ? currentColorForPositionsIndex : 11
            // let conColor = condition_colors[currentColorForConditionsIndex]
            let satellitesObj = {
              'cx': angleForXY[currentColorForPositionsIndex].x,
              'cy': angleForXY[currentColorForPositionsIndex].y,
            }
            satellites.push(satellitesObj)
          }
          //  console.log(d)
           //根据conditions返回绘制光晕数据的数组，动态的长度
           return satellites
         }).enter().append('circle')
         .attr('class','satellite')
         .attr('r', satellite_self_radius)
         .attr('cy', d=>d.cy)
         .attr('cx', d=>d.cx)
         .attr('fill', '#fff')
        //  .style("filter", "url(#motionFilter)")

        // for(let i = 0; i < 13; i ++) {
        //   g.append('circle')
        //   .attr('r', satellite_self_radius)
        //   .attr('cy', function(d) {
        //     let angle = single_satellite_angle*i - Math.PI/2
        //     let light_y = Math.sin(angle)*satellite_radius
        //     return light_y
        //   })
        //   .attr('cx', function(d) {
        //     let angle = single_satellite_angle*i - Math.PI/2
        //     let light_x = Math.cos(angle)*satellite_radius
        //     return light_x
        //   })
        //   .attr('fill',function(d) {
        //     let pos_str = d['Which of the following best describes your work position?']
        //     let state = pos_str.indexOf(pos_list[i])
        //     if(state !== -1) {
        //       return '#fff'
        //     } else {
        //       return 'transparent'
        //     }
        //   })
        //   // .attr('fill-opacity', 1)
        //   // .attr('fill','transparent')
        // }

        //绘制菱形
        g.append('path')
        .attr('d', d3.symbol().type(d3.symbolSquare).size(function(d) {
          let age = Number(d['What is your age?'])
          if(age > 0 && age < 100) {
            return sizeScale(age)
          } else {
            return 0
          }
        }))
        .attr('fill',function(d) {
          if(d['What is your gender?'] === 'Male') {
            return '#fff'
          }  else {
            return 'transparent'
          }
        })
        .attr('transform', 'rotate(45)')
        .attr('class', 'planet-opacity')
        .style(prefix + "animation-duration", function(d) {
          let question_str = d['Do you think that team members/co-workers would view you more negatively if they knew you suffered from a mental health issue?']
          if( question_str === 'Yes, they do') {
            return '1s'
          } else if (question_str === 'Yes, I think they would') {
            return '2s'
           }else if (question_str === "Maybe") {
            return '3s'
           }else if (question_str === "No, I don't think they would") {
            return '4s'
           }else if (question_str === "No, they do not") {
            return '5s'
           } else {
             return '0s'
           }
        })

        //绘制圆形
        g.append('path')
        .attr('d', d3.symbol().type(d3.symbolCircle).size(function(d) {
          let age = Number(d['What is your age?'])
          if(age > 0 && age < 100) {
            return sizeScale(age)
          } else {
            return 0
          }
        }))
        .attr('fill',function(d) {
          if(d['What is your gender?'] === 'Female') {
            return '#fff'
          }  else {
            return 'transparent'
          }
        })
        .attr('class', 'planet-opacity')
        .style(prefix + "animation-duration", function(d) {
          let question_str = d['Do you think that team members/co-workers would view you more negatively if they knew you suffered from a mental health issue?']
          if( question_str === 'Yes, they do') {
            return '1s'
          } else if (question_str === 'Yes, I think they would') {
            return '2s'
           }else if (question_str === "Maybe") {
            return '3s'
           }else if (question_str === "No, I don't think they would") {
            return '4s'
           }else if (question_str === "No, they do not") {
            return '5s'
           } else {
             return '0s'
           }
        })

        //绘制三角形
        g.append('path')
        .attr('d', d3.symbol().type(d3.symbolTriangle).size(function(d) {
          let age = Number(d['What is your age?'])
          if(d['What is your gender?'] !== 'Female' && d['What is your gender?'] !== 'Male' && age > 0 && age < 100) {
            return sizeScale(Number(d['What is your age?']))
          } else {
            return 0
          }
        }))
        .attr('fill','#fff')
        .attr('class', 'planet-opacity')
        .style(prefix + "animation-duration", function(d) {
          let question_str = d['Do you think that team members/co-workers would view you more negatively if they knew you suffered from a mental health issue?']
          if( question_str === 'Yes, they do') {
            return '1s'
          } else if (question_str === 'Yes, I think they would') {
            return '2s'
           }else if (question_str === "Maybe") {
            return '3s'
           }else if (question_str === "No, I don't think they would") {
            return '4s'
           }else if (question_str === "No, they do not") {
            return '5s'
           } else {
             return '0s'
           }
        })

        g.on('click', function(d) {
          // console.log(d)
          showPopup(d)
          let popupBox = document.getElementById("popupBox")
          let popupBoxBound = d3.select('#popupBox').node().getBoundingClientRect()
          let mousex = mouseX
          let mousey = mouseY
          if(popupBoxBound.width + mousex < tempWindowWidth && popupBoxBound.height + mousey < tempWindowHeight) {
            //右下角
             popupBox.style.left =mousex +10 + "px";
             popupBox.style.top = mousey + 10 + "px";
          }else if(popupBoxBound.width + mousex > tempWindowWidth && popupBoxBound.height + mousey < tempWindowHeight) {
            //左下角
            popupBox.style.left =mousex - popupBoxBound.width  + "px";
            popupBox.style.top = mousey + 10 + "px";
          } else if(popupBoxBound.width + mousex > tempWindowWidth && popupBoxBound.height + mousey > tempWindowHeight) {
            //左上角
            popupBox.style.left =mousex - popupBoxBound.width  + "px";
            popupBox.style.top = mousey - popupBoxBound.height + "px";
          }
        })
        .on('mouseover', function(d) {

        })
        // .on('mouseout', function(d) {
        //   document.getElementById("popupBox").style.display = "none";
        // })

      })
    }
      // var g = svg.selectAll('.element').data(dataSet).enter().append('g').attr('class','element')
      // .attr('transform', function(d, i) {
      //   return 'translate(' + i*50 +','+ 10 +')'
      // })
  </script>
  <script src="tree.js"></script>
</body>

</html>